---
title: "netflix_transmutation"
author: "@grevend, @Fynn-Mehrens"
date: "13 12 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
```

## Importing from other Rmd file

This section parses the data from the "netflix_originals.Rmd" file that imported all the data from the scraped CSV files. It saves them into the data frame called "netflix_originals" so that it ca be accessed and manipulated later on.

```{r child = 'netflix_originals.Rmd'}
```

```{r}
netflix_originals <- netflix_originals
# netflix_originals <- read.csv("../datasets/netflix_originals.csv")
netflix_originals
```

## Transmutation of the given Netflix series and movie table

After the data has been imported into the correct columns in the "netflix_originals.Rmd" file, we are now going to transmute the data into the proper data types and into readable formats, as it is needed with multi-value cells like the Genre. For this, we needed a function that parses the value of the cells for the Genre and unifies the content, so that we can be sure that it is in a format that can be properly plotted afterwards.

```{r}
anycharacter <- "([a-zA-Z]|-+)"

genre_to_uppercase <- function(genre) {
  if (length(genre) == 0 | genre == "") {
    return(NA)
  }
  curr <- ""
  all_genres <- ""
  c <- strsplit(genre, "")[[1]]
  for (i in 1:length(c)) {
    if (grepl(anycharacter, c[i])) {
      curr <- gsub(" ", "", str_squish(paste(curr, c[i])))
    }
    if (!grepl(anycharacter, c[i]) | i == length(c)) {
      if (i > 1 & grepl(anycharacter, c[i-1])) {
        whole_word = strsplit(curr, "")[[1]]
        single_genre <- ""
        for (j in 1:length(whole_word)) {
          if (j == 1) {
            single_genre <- gsub(" ", "", str_squish(toupper(whole_word[j])))
          } else {
            single_genre <- gsub(" ", "", str_squish(paste(single_genre, whole_word[j])))
          }
        }
        if (i != length(c)) {
          all_genres <- str_squish(paste(all_genres, single_genre, "/"))
        } else {
          all_genres <- paste(all_genres, single_genre)
        }
      }
      curr <- ""
    }
  }
  return(all_genres)
}

genres_to_uppercase <- function(genres) {
  genres_vector <- c()
  for (genre in genres) {
    genres_vector <- c(genres_vector, c(genre_to_uppercase(genre)))
  }
  return(genres_vector)
}
```

After the function has been defined, we can start converting the columns of the data frame into their respective data types, so that it is easier to deal with them during the plotting process. This means, that the premiere is being converted into a Date object and the Seasons column as well as the Runtime column are converted and split up, so that there are only integer values left. The rest of the columns is just carried over.

```{r}
netflix_originals <- filter(netflix_originals,
                            !grepl("Pending|pending", Title),
                            Title != "Awaiting release",
                            !grepl("Miniseries|miniseries", Title),
                            !grepl("Renewed|renewed", Title),
                            !grepl("due to premiere", Title))

netflix <- transmute(netflix_originals, 
                                Title = Title,
                                Genre = genres_to_uppercase(str_replace_all(
                                          str_squish(
                                            str_replace_all(
                                              str_replace_all(
                                                str_replace_all(
                                                  str_replace_all(
                                                    str_replace_all(Genre, "series|procedural", ""),
                                                  "Science fiction", "Science-Fiction"),
                                                "(C|c)oming-of-age ", ""),
                                              "(C|c)omedy-(D|d)rama", "Dramedy"),
                                            "(Docu|docu).*", "Documentary")
                                          ),
                                        "/| ", " / ")),
                                Premiere = as.Date(str_replace_all(str_replace_all(Premiere, ",", ""), " ", "-"), "%B-%d-%Y"),
                                Episodes = strtoi(ifelse(!is.na(str_match(Seasons, "([0-9]+) (episode*)")[,2]),
                                                  str_match(Seasons, "([0-9]+) (episode*)")[,2],
                                                  NA)),
                                Seasons = strtoi(ifelse(!is.na(str_match(Seasons, "([0-9]) (season.*|part.*|volume.*)")[,2]),
                                                  str_match(Seasons, "([0-9]) (season.*|part.*|volume.*)")[,2],
                                                  NA)),
                                Min_Time = strtoi(ifelse(!is.na(str_match(Runtime, "([0-9]+)-([0-9]+)")[,2]),
                                                  str_match(Runtime, "([0-9]+)-([0-9]+)")[,2],
                                                  str_match(Runtime, "([0-9]+)")[,2])),
                                Max_Time = strtoi(ifelse(!is.na(str_match(Runtime, "([0-9]+)-([0-9]+)")[,3]),
                                                  str_match(Runtime, "([0-9]+)-([0-9]+)")[,3],
                                                  str_match(Runtime, "([0-9]+)")[,2])),
                                Language = Language,
                                Status = Status
                               )

netflix
```
## Data Exploration

To see how the production of original content has evolved over the years, we wanted to take a look at how many productions have been produced in each year.

```{r}
# Adding a column to sort by, will be used as a categorical variable later on
netflix_prem_year <- filter(mutate(netflix, Premiere_Year = lubridate::year(Premiere)), !Premiere_Year == 2021, !is.na(Premiere_Year))
netflix_prem_year

ggplot(data = netflix_prem_year, mapping = aes(x = Premiere_Year, fill = as.factor(Premiere_Year))) +
  geom_bar() +
  labs(fill = "Premiere Year")
```



```{r}
string <- "23 min."

!is.na(str_match(string, "([0-9]+)-([0-9]+)")[,3])
str_match(string, "([0-9]+)")[,2]

matcher <- str_match(string, "([0-9]+)")
matcher
```

```{r}
string <- "2 seasons, 24 episodes"
!is.na(str_match(string, "([0-9])( season)"))
str_match(string, "([0-9])( season)")
```

